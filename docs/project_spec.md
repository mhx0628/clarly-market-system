# 澄迈菜篮子市场管理系统开发文档

## 引言

本文档基于用户提供的最新需求文档（`/jjsystem/doc/摊位租金.txt`）和现有系统设计，旨在为CTO/PE和QO Engineer提供详细的开发指导。作为PMA，我已分析现有设计与新需求的匹配度，并提出更新计划。

### 现有设计分析

#### 覆盖点
- **数据库 schema**：现有 `Merchants`、`Fees`、`Stalls`、`WorkOrders` 等表基本覆盖商户、摊位、费用和工单需求。
- **API 路由**：已实现商户、费用、工单等基本CRUD，支持费用查询和工单提交。
- **前端（商户小程序）**：首页、费用中心、服务工单和个人中心页面已搭建，支持微信登录和基本交互。
- **后端配置**：MySQL连接和环境变量管理已就位。

#### 不足点
- **滞纳金和催缴系统**：现有设计未实现自动计算滞纳金、三级预警机制（微信推送、短信、红牌公示）和自动撤销。
- **管理端和领导看板**：当前仅聚焦商户小程序，缺少PC管理后台和领导大屏功能。
- **集成**：未实现Excel导入、智能电表对接、微信支付和PDF收据生成。
- **非功能需求**：需添加性能优化（如并发测试）、安全措施（加密、备份）和可靠性（主从架构、Redis缓存）。
- **收费规则**：需在数据库中扩展费用规则表，支持动态配置水电费、租金和滞纳金。

现有设计满足约60%的核心需求，但需扩展以覆盖催缴、集成和多端支持，这是市场管理中心的核心业务。

## 系统架构设计

### 高层架构
- **前端**：微信小程序（商户端）、React/Vue Web App（管理端和领导看板）。
- **后端**：Node.js + Express，MySQL主从数据库，Redis缓存。
- **集成**：微信支付API、智能硬件API、短信/语音服务。
- **部署**：Docker容器化，Nginx负载均衡。

### 数据模型更新
- 更新 `Fees` 表：添加 `due_date`、`lag_fee`、`status`（正常/逾期/红牌）。
- 新增 `Notifications` 表：记录推送历史。
- 新增 `MeterReadings` 表：存储水电读数。

### API 合约
- `/api/fees/calculate`：计算费用和滞纳金。
- `/api/notifications/send`：触发预警推送。
- `/api/reports/dashboard`：生成领导看板数据。

## 用户故事

使用MoSCoW方法优先级：Must-have (M), Should-have (S), Could-have (C)。

1. **认证绑定 (M)**：作为商户，我能微信登录并绑定摊位，以便访问个性化服务。
2. **费用中心 (M)**：作为商户，我能查看实时账单、下载收据，并收到逾期预警。
3. **服务工单 (S)**：作为商户，我能提交报修并追踪进度。
4. **催缴系统 (M)**：作为管理员，我能配置规则并监控预警执行。
5. **领导看板 (S)**：作为领导，我能查看实时指标和公示列表。

## 任务分解

### 阶段1：需求实现 (CTO/PE, 2周)
- 任务1.1：扩展数据库 schema 添加滞纳金和通知表。
- 任务1.2：实现费用计算和催缴API。
- 任务1.3：开发管理端Web界面。

### 阶段2：集成与测试 (QO Engineer, 2周)
- 任务2.1：集成微信支付和短信服务。
- 任务2.2：运行并发测试和安全审计。

### 阶段3：部署与优化 (QO Engineer, 1周)
- 任务3.1：设置MySQL主从和Redis。
- 任务3.2：部署到生产环境。

## 开发规范
- 代码风格：ESLint + Prettier。
- 测试覆盖：80%单元测试。
- 文档：每个模块添加JSDoc。

此文档将作为开发蓝图，CTO/PE请据此实施，QO Engineer负责质量把关。如需调整，请反馈。